<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <style>
        :root {
            --primary: #6c5ce7; --success: #00b894; --danger: #ff4757; --warning: #ffa502; --edit: #0984e3;
            --bg: #f0f2f5; --card: #ffffff; --game-menu: #2d3436;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { max-width: 600px; width: 100%; }
        .section { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { text-align: center; color: var(--primary); margin: 0 0 15px 0; }
        
        /* --- GAME SIDEBAR --- */
        #game-sidebar {
            position: fixed; left: 0; top: 0; width: 240px; height: 100%;
            background: var(--game-menu); color: white; padding: 15px; 
            box-shadow: 5px 0 20px rgba(0,0,0,0.3); z-index: 10000; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-110%); 
        }
        #game-sidebar.open { transform: translateX(0); }
        .menu-btn-trigger {
            position: fixed; left: 15px; top: 15px; z-index: 10001;
            background: var(--game-menu); color: white; border: none;
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer; 
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .menu-title { font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 8px; margin: 40px 0 10px 0; color: #fab1a0; display: flex; justify-content: space-between; }
        .game-item { 
            background: rgba(255,255,255,0.08); padding: 10px; border-radius: 8px; 
            margin-bottom: 8px; font-size: 13px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 10px; border-left: 3px solid transparent;
        }
        .game-item:hover { background: rgba(255,255,255,0.15); border-left: 3px solid var(--warning); }
        .hp-hearts { text-align: center; font-size: 20px; margin-bottom: 10px; background: #000; padding: 5px; border-radius: 10px; }
        #city-display { font-size: 18px; text-align: center; background: rgba(0,0,0,0.2); border-radius: 5px; min-height: 25px; margin-top: 5px;}

        /* --- CSS MAIN --- */
        .garden-box { text-align: center; background: linear-gradient(to bottom, #e1f5fe, #ffffff); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #b3e5fc; }
        #tree-emoji { font-size: 50px; display: block; margin-bottom: 5px; transition: 0.3s; }
        .tree-progress-container { width: 100%; height: 10px; background: #e0e0e0; border-radius: 10px; margin-top: 10px; overflow: hidden; border: 1px solid #b3e5fc; }
        #tree-progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #55efc4, #00b894); transition: width 0.5s ease-in-out; }
        .stats-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-item { flex: 1; background: #f8f9fa; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .stat-num { display: block; font-size: 18px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 11px; color: #777; text-transform: uppercase; }
        .input-group { background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 20px; }
        textarea { width: 100%; height: 80px; padding: 12px; border: 2px solid #eee; border-radius: 10px; resize: none; margin-bottom: 10px; font-family: inherit; box-sizing: border-box; }
        .def-edit-area { width: 100%; height: 60px; font-size: 13px; margin-top: 5px; display: none; border: 2px solid var(--edit); border-radius: 10px; padding: 10px; box-sizing: border-box; }
        input[type="text"] { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
        input[type="text"]:disabled { background: #eee; cursor: not-allowed; } 
        button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 2px; }
        .btn-main { background: var(--primary); color: #fff; width: 100%; font-size: 18px; margin-top: 5px; }
        .btn-ai { background: linear-gradient(45deg, #fdcb6e, #e17055); color: #fff; border: 1px solid #e17055; }
        .btn-update { background: #e67e22; color: #fff; width: 100%; margin-top: 10px; font-size: 14px; }
        .btn-secondary { background: #a29bfe; color: #fff; width: 100%; margin-top: 10px; }
        
        /* CSS CHO THANH C√îNG C·ª§ X√ìA M·ªöI */
        .list-toolbar { display: flex; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #eee; position: sticky; top: 0; background: #fafafa; z-index: 5; }
        .btn-delete-multi { flex: 1; background: #fab1a0; color: #d63031; border: 1px solid #ff7675; font-size: 13px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-delete-all { flex: 1; background: #ff7675; color: white; font-size: 13px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-delete-multi:hover, .btn-delete-all:hover { opacity: 0.8; transform: translateY(-1px); }

        .action-group { display: flex; gap: 5px; align-items: center; }
        .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; background: #eee; color: #555; }
        .btn-icon:hover { transform: scale(1.1); }
        .btn-edit:hover { background: var(--edit); color: white; }
        .btn-delete:hover { background: var(--danger); color: white; }
        .list-area { max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-top: 15px; background: #fafafa; display: none; }
        .word-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: white; margin-bottom: 5px; border-radius: 8px; }
        .word-info b { color: var(--primary); font-size: 1.1em; }
        .word-def { font-size: 0.85em; color: #666; font-style: italic; margin-top: 3px; line-height: 1.4; }
        
        /* CSS Timer Bar */
        #timer-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin: 10px 0; overflow: hidden; display: none; }
        #timer-fill { width: 100%; height: 100%; background: var(--danger); transition: width 10s linear; }

        #flashcard { height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 35px; font-weight: bold; border: 3px solid var(--primary); border-radius: 15px; margin: 20px 0; background: #f9f9ff; text-align: center; padding: 20px; position: relative; }
        .hint-box { color: #856404; background-color: #fff3cd; border: 1px dashed #ffeeba; padding: 12px; border-radius: 10px; display: none; margin-top: 5px; font-size: 14px; }
        .loading { font-size: 13px; color: var(--primary); font-weight: bold; display: none; text-align: center; margin: 10px; }
        .shake { animation: shake 0.2s; border-color: var(--danger) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .mode-badge { background: #ffeaa7; color: #d35400; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .chat-area { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        #chat-log { height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 10px; font-size: 13px; margin-bottom: 10px; border: 1px solid #ddd; }
        .msg-ai { color: var(--primary); font-weight: bold; margin-bottom: 5px; }
        .msg-user { color: #444; margin-bottom: 5px; text-align: right; }
    </style>
</head>
<body>

<button class="menu-btn-trigger" id="menuToggleBtn" onclick="document.getElementById('game-sidebar').classList.toggle('open')">‚ò∞</button>

<div id="game-sidebar">
    <div class="menu-title">GI·∫¢I TR√ç <span>‚ò∞</span></div>
    <div class="hp-hearts" id="game-hp">‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è</div>
    
    <div class="game-item" onclick="toggleSurvival()">
        <span>‚öîÔ∏è Sinh T·ªìn (HP)</span> <b id="sv-label" style="margin-left:auto; color:red">OFF</b>
    </div>
    <div class="game-item" onclick="useHint()">
        <span>üõ°Ô∏è G·ª£i √ù (X-Ray)</span> <span id="hint-qty" style="margin-left:auto">2</span>
    </div>
    <div class="game-item" onclick="buildCity()">
        <span>üè† X√¢y Th√†nh Ph·ªë</span>
    </div>
    <div id="city-display"></div>
    
    <div class="game-item" onclick="shuffleWords()">
        <span>üì≥ L·∫Øc ƒê·ªÉ Tr·ªôn</span>
    </div>
    <div class="game-item" onclick="speakCurrent()">
        <span>üé§ ƒê·∫•u Ph√°t √Çm</span>
    </div>
</div>

<div class="container">
    <div id="setup">
        <div class="section">
            <h1>Flashcard Ti·∫øng Anh</h1>
            <p style="font-size: 0.8em; color: gray;">by Trung Nguyen</p>
            <div class="garden-box">
                <span id="tree-emoji">üå±</span>
                <div style="font-size: 12px; color: #2ecc71; font-weight: bold;" id="tree-level">C·∫•p 1: M·∫ßm non</div>
                <div class="tree-progress-container">
                    <div id="tree-progress-fill"></div>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span id="stat-total" class="stat-num">0</span>
                    <span class="stat-label">T·ªïng t·ª´</span>
                </div>
                <div class="stat-item">
                    <span id="stat-mastered" class="stat-num">0%</span>
                    <span class="stat-label">Ho√†n th√†nh</span>
                </div>
            </div>

            <div class="input-group">
                <textarea id="bulkInput" placeholder="V√≠ d·ª•: Fish - con c√°"></textarea>
                <textarea id="editDef" class="def-edit-area" placeholder="ƒê·ªãnh nghƒ©a ti·∫øng Anh..."></textarea>
                <button id="saveBtn" class="btn-main" style="background:#2ecc71;" onclick="addBulkWords()">L∆ØU T·ª∞ V·ª∞NG</button>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="aiTopic" placeholder="Ch·ªß ƒë·ªÅ (vd: Space, Animals)..." style="margin:0">
                <button class="btn-ai" onclick="getAISuggestions()">‚ú® AI G·ª£i √Ω (M·ªõi)</button>
            </div>
            <div id="aiStatus" class="loading">ƒêang k·∫øt n·ªëi server mi·ªÖn ph√≠...</div>
            <button class="btn-update" onclick="autoFillMissingDefs()">‚ú® T·ª∞ ƒê·ªòNG TH√äM ƒê·ªäNH NGHƒ®A</button>
            
            <button class="btn-secondary" onclick="toggleList()">üëÅÔ∏è DANH S√ÅCH T·ª™</button>
            
            <div class="list-area" id="wordListArea">
                <div id="wordListContent"></div>
            </div>

            <div style="margin-top: 20px;">
                <label style="font-size: 14px; font-weight: bold; color: #555;">Ch·∫ø ƒë·ªô h·ªçc:</label>
                <select id="studyModeSelect" style="width: 100%; padding: 10px; border-radius: 10px; margin-top: 5px; border: 2px solid #ddd;">
                    <option value="meaning">ƒêo√°n Nghƒ©a (Nh√¨n t·ª´ -> G√µ nghƒ©a)</option>
                    <option value="reverse">Vi·∫øt l·∫°i t·ª´ (Nh√¨n nghƒ©a -> G√µ t·ª´)</option>
                    <option value="spelling">Ch√≠nh T·∫£ (Nghe t·ª´ -> G√µ t·ª´)</option>
                    <option value="timeattack">üî• ƒê·∫•u Tr∆∞·ªùng Th·ªùi Gian (10 gi√¢y - ƒêo√°n Nghƒ©a)</option>
                </select>
                <button class="btn-main" style="height: 60px; margin-top: 15px;" onclick="startLearning()">B·∫ÆT ƒê·∫¶U H·ªåC ‚Üí</button>
            </div>

            <div class="chat-area">
                <label style="font-size: 14px; font-weight: bold; color: #555;">üí¨ Chat Nh·∫≠p Vai v·ªõi AI:</label>
                <div id="chat-log"><div class="msg-ai">AI: Ch√†o b·∫°n! H√£y th·ª≠ ƒë·∫∑t c√¢u v·ªõi nh·ªØng t·ª´ b·∫°n ƒë√£ h·ªçc nh√©!</div></div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u ti·∫øng Anh..." style="margin:0">
                    <button class="btn-ai" onclick="chatWithAI()">G·ª≠i</button>
                </div>
            </div>
        </div>
    </div>

    <div id="learning" style="display: none;">
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="location.reload()" style="background:none; color:#666; border:1px solid #ccc; padding: 5px 10px;">‚Üê Tho√°t</button>
                <div id="learningMode" class="mode-badge">V√≤ng 1</div>
                <div id="progress" style="font-weight: bold; color: var(--primary);">0/0</div>
            </div>

            <div id="timer-bar"><div id="timer-fill"></div></div>

            <div id="flashcard">
                <div id="displayWord" style="font-size: 28px;"></div>
                <button id="speakBtn" onclick="speakCurrent()" style="background:none; font-size: 30px; margin-top: 10px; display:none; cursor:pointer;">üîä</button>
                <div id="ghost-hint-text" style="font-size: 14px; color: #aaa; margin-top: 10px;"></div>
            </div>
            <div id="result">
                <div id="statusMessage" style="text-align: center; font-weight: bold; margin-bottom: 10px;"></div>
                <div id="hintBox" class="hint-box"></div>
            </div>
            <input type="text" id="guessInput" placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off">
        </div>
    </div>

    <div id="congrats" style="display: none;" class="section">
        <h2 style="text-align:center; color: var(--success);">üéâ Ho√†n th√†nh!</h2>
        <button class="btn-main" onclick="location.reload()">TI·∫æP T·ª§C</button>
    </div>
</div>

<script>
    // --- LOGIC MENU ---
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('game-sidebar');
        const btn = document.getElementById('menuToggleBtn');
        if (!sidebar.contains(event.target) && !btn.contains(event.target)) {
            sidebar.classList.remove('open');
        }
    });

    // --- LOGIC G·ªêC ---
    let masterWords = JSON.parse(localStorage.getItem('flashcards')) || [];
    let sessionWords = [];
    let currentWord = null;
    let mode = 'meaning';
    let timerInterval = null;
    const TIME_LIMIT = 10;
    
    let hp = 3;
    let isSurvival = false;
    let gameHints = 2;

    function toggleSurvival() {
        isSurvival = !isSurvival;
        document.getElementById('sv-label').innerText = isSurvival ? "ON" : "OFF";
        document.getElementById('sv-label').style.color = isSurvival ? "#00b894" : "red";
    }

    function useHint() {
        if(gameHints > 0 && currentWord) {
            gameHints--;
            document.getElementById('hint-qty').innerText = gameHints;
            document.getElementById('ghost-hint-text').innerText = `G·ª£i √Ω: ${currentWord.word[0]}...${currentWord.word.slice(-1)}`;
        } else if (!currentWord) {
            alert("H√£y b·∫Øt ƒë·∫ßu h·ªçc ƒë·ªÉ d√πng g·ª£i √Ω!");
        } else {
            alert("H·∫øt l∆∞·ª£t g·ª£i √Ω!");
        }
    }

    function buildCity() {
        const count = masterWords.length;
        const houses = Math.floor(count / 5);
        let cityStr = "";
        for(let i=0; i<houses; i++) cityStr += "üè†";
        if(houses === 0) alert("C·∫ßn √≠t nh·∫•t 5 t·ª´ ƒë·ªÉ x√¢y nh√†!");
        document.getElementById('city-display').innerText = cityStr || "Ch∆∞a c√≥ nh√†";
    }

    function shuffleWords() {
        if(sessionWords.length > 0) {
            sessionWords.sort(() => Math.random() - 0.5);
            showNext();
            alert("ƒê√£ tr·ªôn th·∫ª!");
        } else {
            alert("V√†o h·ªçc r·ªìi m·ªõi tr·ªôn ƒë∆∞·ª£c!");
        }
    }

    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US';
            window.speechSynthesis.speak(msg);
        }
    }
    function speakCurrent() { if(currentWord) speak(currentWord.word); }

    function updateStats() {
        const count = masterWords.length;
        document.getElementById('stat-total').innerText = count;
        document.getElementById('stat-mastered').innerText = count > 0 ? "Active" : "0%";
        const tree = document.getElementById('tree-emoji');
        const levelText = document.getElementById('tree-level');
        const progressFill = document.getElementById('tree-progress-fill');
        if(count < 5) { tree.innerText = "üå±"; levelText.innerText = "C·∫•p 1: M·∫ßm non"; } 
        else if(count < 15) { tree.innerText = "üåø"; levelText.innerText = "C·∫•p 2: C√¢y nh·ªè"; } 
        else if(count < 30) { tree.innerText = "üå≥"; levelText.innerText = "C·∫•p 3: C√¢y tr∆∞·ªüng th√†nh"; } 
        else { tree.innerText = "üå≤"; levelText.innerText = "C·∫•p 4: ƒê·∫°i th·ª•"; tree.style.filter = "drop-shadow(0 0 5px gold)"; }
        let percentage = (count / 30) * 100;
        if (percentage > 100) percentage = 100;
        progressFill.style.width = percentage + "%";
    }

    function updateHP() {
        let h = "";
        for(let i=0; i<hp; i++) h += "‚ù§Ô∏è ";
        for(let i=0; i<3-hp; i++) h += "üñ§ ";
        document.getElementById('game-hp').innerText = h;
    }

    function startTimer() {
        clearInterval(timerInterval);
        const bar = document.getElementById('timer-bar');
        const fill = document.getElementById('timer-fill');

        if(mode !== 'timeattack') {
            bar.style.display = 'none';
            return;
        }

        bar.style.display = 'block';
        fill.style.transition = 'none';
        fill.style.width = '100%';
        void fill.offsetWidth; 
        fill.style.transition = `width ${TIME_LIMIT}s linear`;
        fill.style.width = '0%';

        timerInterval = setInterval(() => {
            clearInterval(timerInterval);
            document.getElementById('guessInput').disabled = true; 
            document.getElementById('statusMessage').innerHTML = "<span style='color:var(--danger)'>‚åõ H·∫æT GI·ªú! (Sai)</span>";
            handleWrongAnswer();
        }, TIME_LIMIT * 1000);
    }

    async function chatWithAI() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;
        appendMsg(text, 'msg-user');
        input.value = "";
        const learned = masterWords.map(w => w.word).join(", ");
        const prompt = `Friendly teacher response to "${text}". Mention one of these if possible: ${learned}`;
        try {
            const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
            appendMsg(await res.text(), 'msg-ai');
        } catch(e) { appendMsg("L·ªói AI.", 'msg-ai'); }
    }

    function appendMsg(txt, cls) {
        const log = document.getElementById('chat-log');
        log.innerHTML += `<div class="${cls}">${cls==='msg-ai'?'AI: ':'B·∫°n: '}${txt}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function cleanText(text) {
        const articles = ["con", "c√°i", "chi·∫øc", "nh·ªØng", "m·ªôt", "v√†i", "c√°c", "a", "an", "the"];
        let words = text.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g, "").split(/\s+/);
        return words.filter(w => !articles.includes(w) && w !== "").join(" ");
    }

    async function getDefinition(word) {
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await res.json();
            return data[0]?.meanings[0]?.definitions[0]?.definition || "No definition found.";
        } catch (e) { return "Definition unavailable."; }
    }

    async function addBulkWords() {
        const raw = document.getElementById('bulkInput').value.trim();
        const customDef = document.getElementById('editDef').value.trim();
        if (!raw) return;
        const lines = raw.split('\n');
        for (let line of lines) {
            const parts = line.split(/[‚Äì\-:]/);
            if (parts.length >= 2) {
                const w = parts[0].trim();
                const m = parts[1].trim();
                const def = customDef || await getDefinition(w);
                const idx = masterWords.findIndex(x => x.word.toLowerCase() === w.toLowerCase());
                if (idx > -1) masterWords.splice(idx, 1);
                masterWords.push({ word: w, meaning: m, definition: def, failLevel: 0 }); 
            }
        }
        resetInputs();
        saveAndRender();
    }

    async function getAISuggestions() {
        const topic = document.getElementById('aiTopic').value.trim();
        if (!topic) return alert("Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ!");
        
        document.getElementById('aiStatus').style.display = 'block';
        document.getElementById('aiStatus').innerText = "AI ƒëang t√¨m t·ª´ m·ªõi...";
        
        // 1. L·∫•y c√°c t·ª´ ƒë√£ c√≥ ƒë·ªÉ y√™u c·∫ßu AI kh√¥ng tr√πng l·∫∑p
        const existingWords = masterWords.map(w => w.word).join(", ");
        
        // 2. Prompt y√™u c·∫ßu t·ª´ m·ªõi
        const prompt = `Topic: "${topic}". List 5 English words that ARE NOT in this list: [${existingWords}]. 
        Format strictly: English Word - Vietnamese Meaning". Example: "Cat - Con m√®o". Do not use numbering.`;
        
        try {
            const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
            let text = await response.text();
            
            // L√†m s·∫°ch: ch·ªâ gi·ªØ l·∫°i c√°c d√≤ng c√≥ d·∫•u g·∫°ch ngang
            text = text.split('\n').filter(line => line.includes('-')).join('\n');
            
            document.getElementById('bulkInput').value = text.trim();
        } catch (e) { 
            alert("L·ªói AI"); 
        }
        document.getElementById('aiStatus').style.display = 'none';
    }

    function startLearning() {
        if (masterWords.length === 0) return alert("Danh s√°ch tr·ªëng!");
        mode = document.getElementById('studyModeSelect').value;
        masterWords.forEach(w => w.failLevel = 0); 
        sessionWords = [...masterWords].sort(() => Math.random() - 0.5);
        document.getElementById('setup').style.display = 'none';
        document.getElementById('learning').style.display = 'block';
        hp = 3; updateHP();
        showNext();
    }

    function showNext() {
        if (sessionWords.length === 0) {
            clearInterval(timerInterval);
            document.getElementById('learning').style.display = 'none';
            document.getElementById('congrats').style.display = 'block';
            return;
        }
        
        const input = document.getElementById('guessInput');
        input.disabled = false;
        input.value = ''; 
        input.focus();

        currentWord = sessionWords[0];
        document.getElementById('ghost-hint-text').innerText = "";
        const display = document.getElementById('displayWord');
        const speakBtn = document.getElementById('speakBtn');
        
        if(mode === 'spelling') {
            display.innerText = "???";
            speakBtn.style.display = "block";
            speakCurrent();
        } else if(mode === 'reverse') {
            display.innerText = currentWord.meaning;
            speakBtn.style.display = "none";
        } else {
            display.innerText = currentWord.word;
            speakBtn.style.display = "none";
        }
        
        document.getElementById('progress').innerText = `C√≤n l·∫°i: ${sessionWords.length}`;
        let badgeText = "V√≤ng 1";
        if (currentWord.failLevel === 1) badgeText = "√în l·∫°i (Sai l·∫ßn 1)";
        if (currentWord.failLevel >= 2) badgeText = "C·∫ßn nh·ªõ (Sai l·∫ßn 2+)";
        document.getElementById('learningMode').innerText = badgeText;

        document.getElementById('statusMessage').innerText = '';
        document.getElementById('hintBox').style.display = 'none';
        
        startTimer();
    }

    function check() {
        clearInterval(timerInterval);
        const guessRaw = document.getElementById('guessInput').value.trim();
        let isCorrect = false;
        
        if(mode === 'spelling' || mode === 'reverse') {
            isCorrect = (guessRaw.toLowerCase() === currentWord.word.toLowerCase());
        } else {
            const guessClean = cleanText(guessRaw);
            const correctAnswers = currentWord.meaning.split(/[,;]/).map(m => m.trim());
            for (let ans of correctAnswers) {
                if (guessClean === cleanText(ans)) { isCorrect = true; break; }
            }
        }
        
        if (isCorrect) {
            document.getElementById('statusMessage').innerHTML = "<span style='color:var(--success)'>ƒê√∫ng r·ªìi!</span>";
            sessionWords.shift();
            // CHUY·ªÇN NHANH KHI ƒê√öNG (400ms)
            setTimeout(showNext, 400);
        } else {
            handleWrongAnswer();
        }
    }

    function handleWrongAnswer() {
        document.getElementById('flashcard').classList.add('shake');
        setTimeout(() => document.getElementById('flashcard').classList.remove('shake'), 200);
        
        if(isSurvival) {
            hp--; updateHP();
            if(hp <= 0) { 
                clearInterval(timerInterval);
                document.getElementById('guessInput').disabled = true;
                alert("GAME OVER! B·∫°n ƒë√£ h·∫øt m√°u."); 
                location.reload(); 
                return; 
            }
        }

        currentWord.failLevel = (currentWord.failLevel || 0) + 1;

        if (currentWord.failLevel === 1) {
            // SAI L·∫¶N 1: Chuy·ªÉn nhanh (400ms)
            document.getElementById('statusMessage').innerHTML = "<span style='color:var(--danger)'>Sai! (Th·ª≠ l·∫°i sau)</span>";
            sessionWords.push(sessionWords.shift());
            document.getElementById('guessInput').disabled = true;
            setTimeout(showNext, 400); 

        } else if (currentWord.failLevel === 2) {
            // SAI L·∫¶N 2: Hi·ªán ƒë·ªãnh nghƒ©a, chuy·ªÉn h∆°i ch·∫≠m h∆°n (600ms)
            document.getElementById('statusMessage').innerHTML = "<span style='color:var(--warning)'>Sai l·∫ßn 2!</span>";
            sessionWords.push(sessionWords.shift());
            
            document.getElementById('hintBox').style.display = "block";
            document.getElementById('hintBox').innerHTML = `<b>ƒê·ªãnh nghƒ©a:</b> ${currentWord.definition || "N/A"}`;

            document.getElementById('guessInput').disabled = true;
            setTimeout(showNext, 600);

        } else {
            // SAI L·∫¶N 3+: D·ª´ng h·∫≥n
            document.getElementById('statusMessage').innerHTML = "<span style='color:var(--danger)'>Sai l·∫ßn 3! Nh·∫≠p l·∫°i ƒë√°p √°n:</span>";
            document.getElementById('hintBox').style.display = "block";
            let correctAns = (mode === 'meaning' || mode === 'timeattack') ? currentWord.meaning : currentWord.word;
            document.getElementById('hintBox').innerHTML = `<b style="color:red">ƒê√ÅP √ÅN: ${correctAns}</b>`;
            document.getElementById('guessInput').disabled = false;
            document.getElementById('guessInput').value = ""; 
            document.getElementById('guessInput').focus();
        }
    }

    function saveAndRender() {
        localStorage.setItem('flashcards', JSON.stringify(masterWords));
        updateStats();
        const list = document.getElementById('wordListContent');
        if (masterWords.length === 0) { list.innerHTML = "<p style='text-align:center;color:#999'>Tr·ªëng</p>"; return; }
        
        // THANH C√îNG C·ª§ X√ìA
        let html = `
            <div class="list-toolbar">
                <button class="btn-delete-multi" onclick="deleteSelected()">
                    <span>üóëÔ∏è</span> X√≥a m·ª•c ch·ªçn
                </button>
                <button class="btn-delete-all" onclick="deleteAllWords()">
                    <span>üî•</span> X√≥a t·∫•t c·∫£
                </button>
            </div>
        `;
        
        html += masterWords.slice().reverse().map((item, i) => {
            const realIdx = masterWords.length - 1 - i;
            return `<div class="word-item">
                <div style="display:flex; align-items:center; gap:10px; flex:1">
                    <input type="checkbox" class="word-checkbox" data-index="${realIdx}" style="width:18px; height:18px; cursor:pointer;">
                    <div class="word-info">
                        <b>${item.word}</b> <span onclick="speak('${item.word}')" style="cursor:pointer">üîä</span>: ${item.meaning}
                        <div class="word-def">üìñ ${item.definition}</div>
                    </div>
                </div>
                <div class="action-group">
                    <button class="btn-icon btn-edit" onclick="editWord(${realIdx})">‚úé</button>
                    <button class="btn-icon btn-delete" onclick="deleteWord(${realIdx})">‚úï</button>
                </div>
            </div>`;
        }).join('');
        list.innerHTML = html;
    }

    function deleteSelected() {
        const checkboxes = document.querySelectorAll('.word-checkbox:checked');
        if (checkboxes.length === 0) return alert("Ch∆∞a ch·ªçn t·ª´ n√†o!");
        
        if (confirm(`X√≥a ${checkboxes.length} t·ª´ ƒë√£ ch·ªçn?`)) {
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index')));
            indices.sort((a, b) => b - a); // X√≥a t·ª´ d∆∞·ªõi l√™n ƒë·ªÉ kh√¥ng l·ªói index
            indices.forEach(idx => masterWords.splice(idx, 1));
            saveAndRender();
        }
    }

    function editWord(i) {
        let item = masterWords[i];
        document.getElementById('bulkInput').value = `${item.word} - ${item.meaning}`;
        document.getElementById('editDef').value = item.definition;
        document.getElementById('editDef').style.display = 'block';
        masterWords.splice(i, 1);
        saveAndRender();
        toggleList();
    }
    function deleteWord(i) { if (confirm("X√≥a t·ª´?")) { masterWords.splice(i, 1); saveAndRender(); } }
    function deleteAllWords() { if (confirm("X√≥a s·∫°ch?")) { masterWords = []; saveAndRender(); } }
    function toggleList() { 
        const l = document.getElementById('wordListArea'); 
        l.style.display = l.style.display==='block'?'none':'block'; 
        saveAndRender();
    }
    function autoFillMissingDefs() {
        document.getElementById('aiStatus').style.display = 'block';
        let promises = masterWords.map(async (item) => {
            if (!item.definition || item.definition.includes("unavailable")) item.definition = await getDefinition(item.word);
        });
        Promise.all(promises).then(() => { saveAndRender(); document.getElementById('aiStatus').style.display = 'none'; });
    }
    function resetInputs() { document.getElementById('bulkInput').value=''; document.getElementById('editDef').style.display='none'; }
    document.getElementById('guessInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') check(); });
    
    saveAndRender();
</script>
</body>

</html>


